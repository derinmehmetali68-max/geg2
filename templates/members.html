{% extends "base.html" %}

{% block title %}√úyeler - K√ºt√ºphane Y√∂netim Sistemi{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Ba≈ülƒ±k ve Butonlar -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-people"></i> √úye Y√∂netimi</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="showAddMemberModal()">
                        <i class="bi bi-person-plus"></i> Yeni √úye
                    </button>
                    <button class="btn btn-info" onclick="showImportMemberModal()">
                        <i class="bi bi-upload"></i> Excel Y√ºkle
                    </button>
                    <button class="btn btn-warning" onclick="exportMembers()">
                        <i class="bi bi-download"></i> Excel ƒ∞ndir
                    </button>
                    <button class="btn btn-danger" onclick="exportMembersPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> PDF ƒ∞ndir
                    </button>
                </div>
            </div>
            
            <div class="d-flex justify-content-end mb-3 gap-2">
                <a href="/api/members/qr-bulk" class="btn btn-outline-secondary" target="_blank">
                    <i class="bi bi-qr-code"></i> Toplu QR Bas
                </a>
                <button id="bulkQrBtn" class="btn btn-secondary" type="button">
                    <i class="bi bi-qr-code"></i> Se√ßili Olanlar ƒ∞√ßin QR Bas
                </button>
            </div>
            
            <!-- Arama ve Filtreler -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="memberSearch" 
                                       placeholder="Ad soyad, numara veya sƒ±nƒ±f ara...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="classFilter">
                                <option value="">T√ºm Sƒ±nƒ±flar</option>
                                <option value="9">9. Sƒ±nƒ±f</option>
                                <option value="10">10. Sƒ±nƒ±f</option>
                                <option value="11">11. Sƒ±nƒ±f</option>
                                <option value="12">12. Sƒ±nƒ±f</option>
                                <option value="Mezun">Mezun</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="typeFilter">
                                <option value="">T√ºm T√ºrler</option>
                                <option value="√ñƒürenci">√ñƒürenci</option>
                                <option value="√ñƒüretmen">√ñƒüretmen</option>
                                <option value="Personel">Personel</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- √úye Listesi -->
            <div class="card mt-4">
                <ul class="nav nav-tabs" id="memberTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">√úyeler</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="penalized-tab" data-bs-toggle="tab" data-bs-target="#penalized" type="button" role="tab">Cezalƒ±lar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="overdue-tab" data-bs-toggle="tab" data-bs-target="#overdue" type="button" role="tab">Gecikmi≈üler</button>
                    </li>
                </ul>
                <div class="tab-content" id="memberTabsContent">
                    <div class="tab-pane fade show active" id="members" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ad Soyad</th>
                                    <th>Sƒ±nƒ±f</th>
                                    <th>Numara</th>
                                    <th>E-posta</th>
                                     <th>Telefon</th>
                                    <th>√úye T√ºr√º</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Y√ºkleniyor...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sayfalama -->
                    <div id="membersPagination"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="penalized" role="tabpanel">
                        <div class="d-flex justify-content-end mb-3">
                            <!-- Removed Excel export button -->
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ad Soyad</th>
                                        <th>Numara</th>
                                        <th>Sƒ±nƒ±f</th>
                                        <th>E-posta</th>
                                        <th>Ceza Biti≈ü</th>
                                    </tr>
                                </thead>
                                <tbody id="penalizedTableBody">
                                    <!-- Cezalƒ±lar JS ile y√ºklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="overdue" role="tabpanel">
                        <div class="d-flex justify-content-end mb-3">
                            <!-- Removed Excel export button -->
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ad Soyad</th>
                                        <th>Numara</th>
                                        <th>Sƒ±nƒ±f</th>
                                        <th>E-posta</th>
                                        <th>Gecikmi≈ü Kitap</th>
                                        <th>Son Teslim</th>
                                    </tr>
                                </thead>
                                <tbody id="overdueTableBody">
                                    <!-- Gecikmi≈üler JS ile y√ºklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yeni √úye Ekleme Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni √úye Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addMemberForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="addMemberName" class="form-label">Ad Soyad</label>
                            <input type="text" class="form-control" id="addMemberName">
                        </div>
                        <div class="col-md-6">
                            <label for="addMemberClass" class="form-label">Sƒ±nƒ±f</label>
                            <select class="form-select" id="addMemberClass">
                                <option value="">Se√ßiniz</option>
                                <option value="9-A">9-A</option>
                                <option value="9-B">9-B</option>
                                <option value="9-C">9-C</option>
                                <option value="9-D">9-D</option>
                                <option value="10-A">10-A</option>
                                <option value="10-B">10-B</option>
                                <option value="10-C">10-C</option>
                                <option value="10-D">10-D</option>
                                <option value="11-A">11-A</option>
                                <option value="11-B">11-B</option>
                                <option value="11-C">11-C</option>
                                <option value="11-D">11-D</option>
                                <option value="12-A">12-A</option>
                                <option value="12-B">12-B</option>
                                <option value="12-C">12-C</option>
                                <option value="12-D">12-D</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addMemberNumber" class="form-label">Okul Numarasƒ±</label>
                            <input type="text" class="form-control" id="addMemberNumber">
                        </div>
                        <div class="col-12">
                            <label for="addMemberEmail" class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="addMemberEmail">
                        </div>
                        <div class="col-12">
                            <label for="addMemberPhone" class="form-label">Telefon</label>
                            <input type="text" class="form-control" id="addMemberPhone" placeholder="05xx xxx xx xx">
                        </div>
                        <div class="col-12">
                            <label for="addMemberType" class="form-label">√úye T√ºr√º</label>
                            <select class="form-select" id="addMemberType">
                                <option value="√ñƒürenci">√ñƒürenci</option>
                                <option value="√ñƒüretmen">√ñƒüretmen</option>
                                <option value="Personel">Personel</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- √úye D√ºzenleme Modal -->
<div class="modal fade" id="editMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">√úye D√ºzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="editMemberName" class="form-label">Ad Soyad</label>
                            <input type="text" class="form-control" id="editMemberName">
                        </div>
                        <div class="col-md-6">
                            <label for="editMemberClass" class="form-label">Sƒ±nƒ±f</label>
                            <select class="form-select" id="editMemberClass">
                                <option value="">Se√ßiniz</option>
                                <option value="9-A">9-A</option>
                                <option value="9-B">9-B</option>
                                <option value="9-C">9-C</option>
                                <option value="9-D">9-D</option>
                                <option value="10-A">10-A</option>
                                <option value="10-B">10-B</option>
                                <option value="10-C">10-C</option>
                                <option value="10-D">10-D</option>
                                <option value="11-A">11-A</option>
                                <option value="11-B">11-B</option>
                                <option value="11-C">11-C</option>
                                <option value="11-D">11-D</option>
                                <option value="12-A">12-A</option>
                                <option value="12-B">12-B</option>
                                <option value="12-C">12-C</option>
                                <option value="12-D">12-D</option>
                                <option value="Mezun">Mezun</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editMemberNumber" class="form-label">Okul Numarasƒ±</label>
                            <input type="text" class="form-control" id="editMemberNumber">
                        </div>
                        <div class="col-12">
                            <label for="editMemberEmail" class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="editMemberEmail">
                        </div>
                        <div class="col-12">
                            <label for="editMemberPhone" class="form-label">Telefon</label>
                            <input type="text" class="form-control" id="editMemberPhone" placeholder="05xx xxx xx xx">
                        </div>
                        <div class="col-12">
                            <label for="editMemberType" class="form-label">√úye T√ºr√º</label>
                            <select class="form-select" id="editMemberType">
                                <option value="√ñƒürenci">√ñƒürenci</option>
                                <option value="√ñƒüretmen">√ñƒüretmen</option>
                                <option value="Personel">Personel</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> G√ºncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Excel ƒ∞√ße Aktarma Modal -->
<div class="modal fade" id="importMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Excel'den √úye Y√ºkle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="importMemberForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Excel Formatƒ±:</strong><br>
                        ad_soyad | sinif | numara | email | uye_turu
                    </div>
                    <div class="mb-3">
                        <label for="importMemberFile" class="form-label">Excel Dosyasƒ± Se√ßin</label>
                        <input type="file" class="form-control" id="importMemberFile" accept=".xlsx,.xls" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Y√ºkle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak kod - OPTƒ∞Mƒ∞ZE EDƒ∞LMƒ∞≈û
$(document).ready(function() {
    console.log('üë• √úye sayfasƒ± y√ºkleniyor...');
    
    // √úyeleri y√ºkle - async olarak
    setTimeout(function() {
        if (typeof loadMembers === 'function') {
            loadMembers(1);
        }
    }, 100);
    
    // Event listener'larƒ± ekle - basit
    $('#classFilter, #typeFilter').on('change', function() {
        if (typeof loadMembers === 'function') {
            loadMembers(1);
        }
    });
    
    console.log('‚úÖ √úye sayfasƒ± hazƒ±r');
});

// Modal fonksiyonlarƒ±
function showAddMemberModal() {
    $('#addMemberModal').modal('show');
}

function showImportMemberModal() {
    $('#importMemberFile').val('');
    $('#importMemberModal').modal('show');
}

// √úye ekleme - inline
function addMember() {
    const data = {
        ad_soyad: $('#addMemberName').val(),
        sinif: $('#addMemberClass').val(),
        numara: $('#addMemberNumber').val(),
        email: $('#addMemberEmail').val(),
        phone: $('#addMemberPhone').val(),
        uye_turu: $('#addMemberType').val()
    };
    
    // Eksik bilgiler olsa da kayda izin verilir
    
    $.ajax({
        url: '/api/members',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            showToast('√úye eklendi', 'success');
            $('#addMemberModal').modal('hide');
            $('#addMemberForm')[0].reset();
            if (typeof loadMembers === 'function') {
                loadMembers(currentMemberPage || 1);
            }
        },
        error: function(xhr) {
            showToast(xhr.responseJSON?.message || 'Ekleme hatasƒ±', 'error');
        }
    });
}

// √úye d√ºzenleme - inline
function editMember(id) {
    $.ajax({
        url: `/api/members/${id}`,
        method: 'GET',
        timeout: 2000,
        success: function(member) {
            $('#editMemberId').val(member.id);
            $('#editMemberName').val(member.ad_soyad);
            $('#editMemberClass').val(member.sinif);
            $('#editMemberNumber').val(member.numara);
            $('#editMemberEmail').val(member.email);
            $('#editMemberPhone').val(member.phone || '');
            $('#editMemberType').val(member.uye_turu);
            
            $('#editMemberModal').modal('show');
        },
        error: function() {
            showToast('√úye bilgileri alƒ±namadƒ±', 'error');
        }
    });
}

// √úye g√ºncelleme - inline
function updateMember() {
    const id = $('#editMemberId').val();
    const data = {
        ad_soyad: $('#editMemberName').val(),
        sinif: $('#editMemberClass').val(),
        numara: $('#editMemberNumber').val(),
        email: $('#editMemberEmail').val(),
        phone: $('#editMemberPhone').val(),
        uye_turu: $('#editMemberType').val()
    };
    
    // Eksik bilgiler olsa da kayda izin verilir
    
    $.ajax({
        url: `/api/members/${id}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            showToast('√úye g√ºncellendi', 'success');
            $('#editMemberModal').modal('hide');
            if (typeof loadMembers === 'function') {
                loadMembers(currentMemberPage || 1);
            }
        },
        error: function(xhr) {
            showToast(xhr.responseJSON?.message || 'G√ºncelleme hatasƒ±', 'error');
        }
    });
}

// Export √ºyeler - inline
function exportMembers() {
    const link = document.createElement('a');
    link.href = '/api/export/members';
    link.download = `uyeler_${new Date().toISOString().split('T')[0]}.xlsx`;
    link.click();
    showToast('Excel dosyasƒ± indiriliyor...', 'success');
}

// Import √ºyeler - inline
function importMembers() {
    const fileInput = $('#importMemberFile')[0];
    
    if (!fileInput.files.length) {
        showToast('L√ºtfen bir dosya se√ßin', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
            // Loading state with progress
        const submitBtn = $('#importMemberForm button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="spinner-border spinner-border-sm me-2"></i>Y√ºkleniyor...')
               .prop('disabled', true);
        
        // Progress indicator
        const progressHtml = `
            <div id="importProgress" class="mt-3">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-1 d-block">
                    <i class="fas fa-clock"></i> ƒ∞≈ülem ba≈ülatƒ±lƒ±yor...
                </small>
            </div>
        `;
        $(this).find('.modal-body').append(progressHtml);
        
        // Simulate progress for large files
        const fileSize = fileInput.files[0].size;
        if (fileSize > 100000) { // 100KB'dan b√ºy√ºk dosyalar i√ßin
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;
                
                $('#importProgress .progress-bar').css('width', progress + '%');
                $('#importProgress small').html(`
                    <i class="fas fa-upload"></i> ƒ∞≈üleniyor... ${Math.round(progress)}%
                    <br><small>B√ºy√ºk dosyalar i√ßin l√ºtfen bekleyin</small>
                `);
            }, 500);
            
            // Clear interval on complete
            $(document).one('import-complete', function() {
                clearInterval(progressInterval);
                $('#importProgress .progress-bar').css('width', '100%');
                $('#importProgress small').html('<i class="fas fa-check"></i> Tamamlandƒ±!');
            });
        }
    
            $.ajax({
            url: '/api/import/members',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            timeout: 300000, // 5 dakika timeout (b√ºy√ºk dosyalar i√ßin)
        success: function(response) {
            console.log('Import response:', response);
            
            if (response.success) {
                // Ba≈üarƒ±lƒ± import - detaylƒ± mesaj g√∂ster
                showImportResults(response, 'success');
                $('#importMemberModal').modal('hide');
                if (typeof loadMembers === 'function') {
                    loadMembers(1);
                }
            } else {
                // Ba≈üarƒ±sƒ±z import - detaylƒ± hata g√∂ster
                showImportResults(response, 'error');
            }
        },
        error: function(xhr) {
            console.error('Import error:', xhr);
            const message = xhr.responseJSON?.message || 'Excel y√ºkleme hatasƒ±';
            showToast(message, 'error');
        },
        complete: function() {
            $(document).trigger('import-complete');
            setTimeout(() => {
                submitBtn.html(originalText).prop('disabled', false);
                $('#importProgress').fadeOut(300, function() {
                    $(this).remove();
                });
            }, 1000);
        }
    });
}

$('#bulkPdfBtn').on('click', function() {
    const selected = $('.member-checkbox:checked').map(function(){return this.value;}).get();
    if(selected.length === 0) {
        showToast('L√ºtfen en az bir √ºye se√ßin', 'warning');
        return;
    }
    // PDF indirmek i√ßin POST ile veri g√∂nder
    const form = $('<form>', {method: 'POST', action: '/api/members/pdf-bulk', target: '_blank'});
    $('<input>', {type: 'hidden', name: 'ids', value: JSON.stringify(selected)}).appendTo(form);
    form.appendTo('body').submit().remove();
});

// Excel Import Form Handler - Eksik olan kƒ±smƒ± ekliyoruz
$('#importMemberForm').on('submit', function(e) {
    e.preventDefault();
    importMembers();
});

// Import sonu√ßlarƒ±nƒ± detaylƒ± g√∂ster
function showImportResults(response, type) {
    let modalHtml = `
        <div class="modal fade" id="importResultsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-${type === 'success' ? 'success' : 'danger'} text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                            Excel Import Sonu√ßlarƒ±
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-${type === 'success' ? 'success' : 'danger'}">
                            ${response.message.replace(/\\n/g, '<br>')}
                        </div>`;
    
    if (response.details) {
        // ƒ∞statistikler
        if (response.details.stats) {
            const stats = response.details.stats;
            modalHtml += `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><strong>üìä ƒ∞statistikler</strong></div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>‚úÖ Eklenen:</span>
                                        <badge class="badge bg-success">${stats.added_count}</badge>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>‚è≠Ô∏è Atlanan:</span>
                                        <badge class="badge bg-warning">${stats.skipped_count}</badge>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>‚ùå Hata:</span>
                                        <badge class="badge bg-danger">${stats.error_count}</badge>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>üîÑ Duplicate:</span>
                                        <badge class="badge bg-info">${stats.duplicate_count}</badge>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><strong>üóÇÔ∏è S√ºtun E≈üleme</strong></div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">`;
            
            if (response.details.mapped_columns) {
                Object.entries(response.details.mapped_columns).forEach(([system, excel]) => {
                    modalHtml += `
                        <li class="list-group-item small">
                            <strong>${system}:</strong> ${excel}
                        </li>`;
                });
            }
            
            modalHtml += `
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        // Ba≈üarƒ±lƒ± kayƒ±tlar
        if (response.details.successful_records && response.details.successful_records.length > 0) {
            modalHtml += `
                <div class="card mb-3">
                    <div class="card-header"><strong>‚úÖ Ba≈üarƒ±lƒ± Kayƒ±tlar</strong></div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Satƒ±r</th><th>Ad Soyad</th><th>Numara</th><th>Sƒ±nƒ±f</th></tr></thead>
                                <tbody>`;
            
            response.details.successful_records.forEach(record => {
                modalHtml += `
                    <tr>
                        <td>${record.row}</td>
                        <td>${record.name}</td>
                        <td>${record.number}</td>
                        <td>${record.class}</td>
                    </tr>`;
            });
            
            modalHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }
        
        // Hatalar
        if (response.details.errors && response.details.errors.length > 0) {
            modalHtml += `
                <div class="card mb-3">
                    <div class="card-header text-danger">
                        <strong>‚ùå Hatalar</strong>
                        ${response.details.total_errors > response.details.errors.length ? 
                          `<small>(${response.details.errors.length}/${response.details.total_errors} g√∂steriliyor)</small>` : ''}
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">`;
            
            response.details.errors.forEach(error => {
                modalHtml += `<li class="list-group-item text-danger small">${error}</li>`;
            });
            
            modalHtml += `
                        </ul>
                    </div>
                </div>`;
        }
    }
    
    modalHtml += `
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    </div>
                </div>
            </div>
        </div>`;
    
    // Eski modal varsa kaldƒ±r
    $('#importResultsModal').remove();
    
    // Yeni modal ekle ve g√∂ster
    $('body').append(modalHtml);
    $('#importResultsModal').modal('show');
    
    // Modal kapandƒ±ƒüƒ±nda temizle
    $('#importResultsModal').on('hidden.bs.modal', function() {
        $(this).remove();
    });
}

// Cezalƒ±lar ve gecikmi≈üler tablosunu y√ºkle
function loadPenalizedMembers() {
    $.get('/api/members/penalized', function(data) {
        const tbody = $('#penalizedTableBody');
        tbody.empty();
        if (!data.members || data.members.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center text-muted">Cezalƒ± √ºye yok</td></tr>');
            return;
        }
        data.members.forEach(m => {
            tbody.append(`<tr>
                <td>${m.ad_soyad}</td>
                <td>${m.numara}</td>
                <td>${m.sinif}</td>
                <td>${m.email}</td>
                <td>${m.penalty_until ? m.penalty_until.split('T')[0] : ''}</td>
            </tr>`);
        });
    });
}
function loadOverdueMembers() {
    $.get('/api/members/overdue', function(data) {
        const tbody = $('#overdueTableBody');
        tbody.empty();
        if (!data.members || data.members.length === 0) {
            tbody.html('<tr><td colspan="6" class="text-center text-muted">Gecikmi≈ü √ºye yok</td></tr>');
            return;
        }
        data.members.forEach(m => {
            tbody.append(`<tr>
                <td>${m.ad_soyad}</td>
                <td>${m.numara}</td>
                <td>${m.sinif}</td>
                <td>${m.email}</td>
                <td>${m.book_title}</td>
                <td>${m.due_date}</td>
            </tr>`);
        });
    });
}

// PDF ƒ∞ndir
function exportMembersPDF() {
    showToast('PDF olu≈üturuluyor...', 'info');
    fetch('/api/members/list-pdf')
        .then(async (response) => {
            if (!response.ok) {
                let message = 'PDF indirilemedi';
                try { message = (await response.json()).error || message; } catch (_) {}
                throw new Error(message);
            }
            const ct = (response.headers.get('Content-Type') || '').toLowerCase();
            if (!ct.includes('application/pdf')) {
                let message = 'PDF olu≈üturulamadƒ±';
                try { message = (await response.json()).error || message; } catch (_) {}
                throw new Error(message);
            }
            const blob = await response.blob();
            const cd = response.headers.get('Content-Disposition') || '';
            const match = cd.match(/filename="?([^";]+)"?/i);
            const filename = match ? match[1] : `uyeler_listesi_${new Date().toISOString().slice(0,16).replace(/[-:T]/g,'')}.pdf`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
            showToast('PDF dosyasƒ± indirildi!', 'success');
        })
        .catch((err) => {
            console.error('Members PDF Error:', err);
            showToast(err.message || 'PDF olu≈üturulurken hata olu≈ütu', 'error');
        });
}
// Global eri≈üim
window.exportMembersPDF = exportMembersPDF;

$('#penalized-tab').on('shown.bs.tab', loadPenalizedMembers);
$('#overdue-tab').on('shown.bs.tab', loadOverdueMembers);
</script>
{% endblock %}
