{% extends "base.html" %}

{% block title %}Kitaplar - KÃ¼tÃ¼phane YÃ¶netim Sistemi{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- BaÅŸlÄ±k ve Butonlar -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-book"></i> Kitap YÃ¶netimi</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="showAddBookModal()">
                        <i class="bi bi-plus-circle"></i> Yeni Kitap
                    </button>
                    <button class="btn btn-primary" onclick="showFetchBooksModal()">
                        <i class="bi bi-magic"></i> ISBN ile HÄ±zlÄ± Ekleme
                    </button>
                    <button class="btn btn-info" onclick="showImportModal()">
                        <i class="bi bi-upload"></i> Excel YÃ¼kle
                    </button>
                    <button class="btn btn-warning" onclick="exportBooks()">
                        <i class="bi bi-download"></i> Excel Ä°ndir
                    </button>
                    <button class="btn btn-danger" onclick="exportBooksPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> PDF Ä°ndir
                    </button>
                    <button class="btn btn-secondary" onclick="downloadMissingCovers()" title="Kapak resmi eksik kitaplar iÃ§in otomatik indir">
                        <i class="bi bi-image"></i> Kapak Tamamla
                    </button>
                    <button class="btn btn-dark" onclick="completeAllBooksInfo()" title="TÃ¼m kitaplarÄ±n bilgilerini API'den doÄŸrula ve gÃ¼ncelle">
                        <i class="bi bi-database-fill-check"></i> TÃ¼m Kitap Bilgileri Tamamla
                    </button>
                </div>
            </div>
            
            <!-- Arama ve Filtreler -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="bookSearch" 
                                       placeholder="Kitap adÄ±, yazar veya ISBN ara...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="categoryFilter">
                                <option value="">TÃ¼m Kategoriler</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Birden fazla kategori ile filtreleme iÃ§in CTRL ile seÃ§in (yakÄ±nda).</small>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">TÃ¼m Durumlar</option>
                                <option value="available">Mevcut</option>
                                <option value="borrowed">Ã–dÃ¼nÃ§ VerilmiÅŸ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kitap Listesi -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-3 gap-2">
                        <a href="/api/books/qr-bulk" class="btn btn-outline-secondary" target="_blank">
                            <i class="bi bi-qr-code"></i> TÃ¼m Kitaplar QR
                        </a>
                        <button id="bulkQrBtn" class="btn btn-secondary" type="button">
                            <i class="bi bi-qr-code"></i> SeÃ§ili Olanlar Ä°Ã§in QR Bas
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllBooks"></th>
                                    <th>ISBN</th>
                                    <th>Kapak</th>
                                    <th>Kitap AdÄ±</th>
                                    <th>Yazar</th>
                                    <th>YayÄ±nevi</th>
                                    <th>Kategori</th>
                                    <th>Raf</th>
                                    <th>Dolap</th>
                                    <th>Mevcut</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="booksTableBody">
                                <tr>
                                    <td colspan="11" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">YÃ¼kleniyor...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sayfalama -->
                    <div id="booksPagination"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yeni Kitap Ekleme Modal -->
<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Kitap Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addBookForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="addBookISBN" class="form-label">ISBN *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="addBookISBN" placeholder="9786051850078" required>
                                <button type="button" class="btn btn-outline-primary" onclick="fetchBookFromISBN()">
                                    <i class="bi bi-search"></i> BaÅŸlÄ±k ve Bilgileri Getir
                                </button>
                            </div>
                            <small class="text-muted">ISBN numarasÄ±nÄ± girdikten sonra "BaÅŸlÄ±k ve Bilgileri Getir" butonuna tÄ±klayarak kitap bilgilerini otomatik doldurabilirsiniz.</small>
                        </div>
                        <div class="col-md-6">
                            <label for="addBookTitle" class="form-label">Kitap AdÄ±</label>
                            <input type="text" class="form-control" id="addBookTitle">
                        </div>
                        <div class="col-md-6">
                            <label for="addBookAuthors" class="form-label">Yazar(lar)</label>
                            <input type="text" class="form-control" id="addBookAuthors">
                        </div>
                        <div class="col-md-6">
                            <label for="addBookPublishers" class="form-label">YayÄ±nevi</label>
                            <input type="text" class="form-control" id="addBookPublishers">
                        </div>
                        <div class="col-md-4">
                            <label for="addBookPublishDate" class="form-label">YayÄ±n YÄ±lÄ±</label>
                            <input type="text" class="form-control" id="addBookPublishDate" placeholder="2023">
                        </div>
                        <div class="col-md-4">
                            <label for="addBookPages" class="form-label">Sayfa SayÄ±sÄ±</label>
                            <input type="number" class="form-control" id="addBookPages" min="1">
                        </div>
                        <div class="col-md-4">
                            <label for="addBookLanguages" class="form-label">Dil</label>
                            <input type="text" class="form-control" id="addBookLanguages" value="TÃ¼rkÃ§e">
                        </div>
                        <div class="col-md-4">
                            <label for="addBookQuantity" class="form-label">Adet</label>
                            <input type="number" class="form-control" id="addBookQuantity" value="1" min="1">
                        </div>
                        <div class="col-md-4">
                            <label for="addBookShelf" class="form-label">Raf</label>
                            <input type="text" class="form-control" id="addBookShelf" placeholder="A-1">
                        </div>
                        <div class="col-md-4">
                            <label for="addBookCategories" class="form-label">Kategoriler (TR lise listesi)</label>
                            <select class="form-select" id="addBookCategories" multiple size="6">
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Birden fazla kategori seÃ§ebilirsiniz.</small>
                        </div>
                        <div class="col-md-4">
                            <label for="addBookCupboard" class="form-label">Dolap</label>
                            <input type="text" class="form-control" id="addBookCupboard" placeholder="1">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Kapak Resmi (Manuel YÃ¼kleme)</label>
                            <input type="file" class="form-control" id="addBookCover" accept="image/*">
                            <small class="text-muted">API kapak getiremezse buradan yÃ¼kleyebilirsiniz.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kitap DÃ¼zenleme Modal -->
<div class="modal fade" id="editBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kitap DÃ¼zenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editBookForm">
                <input type="hidden" id="editBookISBN">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="editBookISBNDisplay" disabled>
                        </div>
                        <div class="col-md-6">
                            <label for="editBookTitle" class="form-label">Kitap AdÄ±</label>
                            <input type="text" class="form-control" id="editBookTitle">
                        </div>
                        <div class="col-md-6">
                            <label for="editBookAuthors" class="form-label">Yazar(lar)</label>
                            <input type="text" class="form-control" id="editBookAuthors">
                        </div>
                        <div class="col-md-6">
                            <label for="editBookPublishers" class="form-label">YayÄ±nevi</label>
                            <input type="text" class="form-control" id="editBookPublishers">
                        </div>
                        <div class="col-md-4">
                            <label for="editBookPublishDate" class="form-label">YayÄ±n YÄ±lÄ±</label>
                            <input type="text" class="form-control" id="editBookPublishDate">
                        </div>
                        <div class="col-md-4">
                            <label for="editBookPages" class="form-label">Sayfa SayÄ±sÄ±</label>
                            <input type="number" class="form-control" id="editBookPages" min="1">
                        </div>
                        <div class="col-md-4">
                            <label for="editBookLanguages" class="form-label">Dil</label>
                            <input type="text" class="form-control" id="editBookLanguages">
                        </div>
                        <div class="col-md-4">
                            <label for="editBookQuantity" class="form-label">Adet</label>
                            <input type="number" class="form-control" id="editBookQuantity" min="1">
                        </div>
                        <div class="col-md-4">
                            <label for="editBookShelf" class="form-label">Raf</label>
                            <input type="text" class="form-control" id="editBookShelf">
                        </div>
                        <div class="col-md-4">
                            <label for="editBookCategories" class="form-label">Kategoriler</label>
                            <select class="form-select" id="editBookCategories" multiple size="10" style="height: 240px; overflow-y: auto;">
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="d-flex gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveCategoryOption('editBookCategories', -1)">â–² YukarÄ±</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveCategoryOption('editBookCategories', 1)">â–¼ AÅŸaÄŸÄ±</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllCategories('editBookCategories')">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllCategories('editBookCategories')">Temizle</button>
                            </div>
                            <small class="text-muted">Ok tuÅŸlarÄ± ile sÄ±ralayabilir, birden fazla kategori seÃ§ebilirsiniz.</small>
                        </div>
                        <div class="col-md-4">
                            <label for="editBookCupboard" class="form-label">Dolap</label>
                            <input type="text" class="form-control" id="editBookCupboard">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Kapak Resmi (Manuel YÃ¼kleme)</label>
                            <input type="file" class="form-control" id="editBookCover" accept="image/*">
                            <small class="text-muted">Dosya seÃ§erseniz kayÄ±t sonrasÄ± kapak yÃ¼klenecektir.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> GÃ¼ncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ISBN ile Kitap Getirme Modal -->
<div class="modal fade" id="fetchBooksModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ISBN ile Kitap Bilgisi Getir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="fetchISBNs" class="form-label">ISBN NumaralarÄ± (her satÄ±ra bir tane)</label>
                            <textarea class="form-control" id="fetchISBNs" rows="5" 
                                      placeholder="9789750719387&#10;9786053753742&#10;9789756525265"></textarea>
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-primary" onclick="fetchBooks()">
                                <i class="bi bi-search"></i> Bilgileri Getir
                            </button>
                            <button type="button" class="btn btn-success" id="fetchAndSaveBtn" onclick="fetchAndSaveAll()" title="ISBN'leri getir ve otomatik kaydet">
                                <i class="bi bi-magic"></i> Getir ve Kaydet
                            </button>
                            <button type="button" class="btn btn-info" onclick="showFetchFileOptions()" title="Dosyadan ISBN'leri yÃ¼kle">
                                <i class="bi bi-upload"></i> Dosyadan YÃ¼kle
                            </button>
                        </div>
                        
                        <!-- Dosya yÃ¼kleme alanÄ± -->
                        <div id="fetchFileUploadArea" style="display: none;" class="card bg-light mb-3">
                            <div class="card-body">
                                <h6><i class="bi bi-file-text"></i> Dosyadan ISBN YÃ¼kle</h6>
                                <input type="file" class="form-control mb-2" id="fetchFileInput" accept=".txt,.csv,.xlsx,.xls">
                                <small class="text-muted">TXT, CSV veya Excel dosyasÄ±ndan ISBN'leri otomatik yÃ¼kler</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <!-- Ä°ÅŸlem durum kartÄ± -->
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Ä°ÅŸlem Durumu</h6>
                            </div>
                            <div class="card-body">
                                <div id="fetchStatus">
                                    <p class="text-muted small">ISBN'leri girin ve iÅŸleme baÅŸlayÄ±n</p>
                                </div>
                                <div class="progress mb-2" id="fetchProgress" style="display: none;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="fetchedBooksTable" style="display:none;">
                    <h6>Bulunan Kitaplar:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ISBN</th>
                                    <th>BaÅŸlÄ±k</th>
                                    <th>Yazar</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="fetchedBooksBody"></tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-success mt-2" onclick="saveAllFetchedBooks()">
                        <i class="bi bi-save"></i> TÃ¼mÃ¼nÃ¼ Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Excel Ä°Ã§e Aktarma Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Excel'den Kitap YÃ¼kle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="importForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>Excel FormatÄ±:</strong><br>
                                ISBN | BaÅŸlÄ±k | Yazar | YayÄ±n YÄ±lÄ± | Sayfa SayÄ±sÄ± | YayÄ±nevi | Diller | Adet | Raf | Dolap | Kategori
                            </div>
                            <div class="mb-3">
                                <label for="importFile" class="form-label">Excel DosyasÄ± SeÃ§in</label>
                                <input type="file" class="form-control" id="importFile" accept=".xlsx,.xls" required>
                            </div>
                            
                            <!-- Yeni ISBN Tamamlama Ã–zelliÄŸi -->
                            <div class="card bg-light mt-3" id="isbnAutoCompleteCard" style="display: none;">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-magic"></i> ISBN'den Otomatik Tamamlama</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-2">
                                        DosyanÄ±zda sadece ISBN sÃ¼tunu varsa, diÄŸer bilgileri otomatik olarak tamamlayabiliriz.
                                    </p>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-success" id="autoCompleteBtn">
                                            <i class="bi bi-cloud-download"></i> ISBN'lerden Bilgi Tamamla
                                        </button>
                                        <div class="progress mt-2" id="autoCompleteProgress" style="display: none;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="autoCompleteStatus"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Ã–nizleme AlanÄ± -->
                            <div class="card" id="previewCard" style="display: none;">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-eye"></i> Excel Ã–nizleme</h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="previewTable"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> YÃ¼kle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toast mesaj fonksiyonu - Basit versiyon
function showToast(message, type = 'info') {
    // Bootstrap 5 toast kullan
    const toastContainer = document.getElementById('toast-container') || (() => {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    })();
    
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' :
                   type === 'error' ? 'bg-danger' :
                   type === 'warning' ? 'bg-warning' : 'bg-info';
    
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    // Otomatik temizle
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Global showToast
window.showToast = showToast;

// Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak kod - OPTÄ°MÄ°ZE EDÄ°LMÄ°Åž
$(document).ready(function() {
    console.log('ðŸ“š Kitap sayfasÄ± yÃ¼kleniyor...');
    
    // KitaplarÄ± yÃ¼kle - async olarak
    setTimeout(function() {
        if (typeof loadBooks === 'function') {
            loadBooks(1);
        }
    }, 100);
    
    // Event listener'larÄ± ekle - basit
    $('#categoryFilter, #statusFilter').on('change', function() {
        if (typeof loadBooks === 'function') {
            loadBooks(1);
        }
    });
    
    console.log('âœ… Kitap sayfasÄ± hazÄ±r');
});

// Modal fonksiyonlarÄ± - Basit versiyon
function showAddBookModal() {
    $('#addBookModal').modal('show');
}

function showFetchBooksModal() {
    $('#fetchISBNs').val('');
    $('#fetchedBooksTable').hide();
    $('#fetchFileUploadArea').hide();
    $('#fetchFileInput').val('');
    $('#fetchProgress').hide();
    $('#fetchStatus').html('<p class="text-muted small">ISBN\'leri girin ve iÅŸleme baÅŸlayÄ±n</p>');
    $('#fetchBooksModal').modal('show');
}

function showImportModal() {
    $('#importFile').val('');
    $('#previewCard').hide();
    $('#isbnAutoCompleteCard').hide();
    $('#importModal').modal('show');
}

// ISBN ile kitap bilgilerini getir (Yeni Kitap Formu iÃ§in)
function fetchBookFromISBN() {
    const isbn = $('#addBookISBN').val().trim();
    
    if (!isbn) {
        showToast('LÃ¼tfen ISBN numarasÄ± girin', 'warning');
        return;
    }
    
    // Mevcut buton referansÄ±nÄ± al
    const btn = event?.target || $('button[onclick="fetchBookFromISBN()"]')[0];
    const originalText = btn ? btn.innerHTML : '';
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="spinner-border spinner-border-sm"></i> Getiriliyor...';
    }
    
    $.ajax({
        url: '/api/books/fetch-from-isbn',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ isbn: isbn }),
        success: function(response) {
            if (response.success && response.book) {
                const book = response.book;
                
                // Form alanlarÄ±nÄ± doldur
                $('#addBookTitle').val(book.title || '');
                $('#addBookAuthors').val(book.authors || '');
                $('#addBookPublishers').val(book.publishers || '');
                $('#addBookPublishDate').val(book.publish_date || '');
                $('#addBookPages').val(book.number_of_pages || '');
                $('#addBookLanguages').val(book.languages || 'TÃ¼rkÃ§e');
                
                showToast('Kitap bilgileri baÅŸarÄ±yla getirildi!', 'success');
            } else {
                showToast(response.message || 'Kitap bilgileri bulunamadÄ±', 'warning');
            }
        },
        error: function(xhr) {
            const message = xhr.responseJSON?.message || 'Bilgiler getirilemedi';
            const isExisting = xhr.responseJSON?.existing;
            
            if (isExisting) {
                showToast('Bu ISBN numarasÄ±na sahip kitap zaten mevcut', 'warning');
            } else {
                showToast(message, 'error');
            }
        },
        complete: function() {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    });
}

// Global eriÅŸim
window.fetchBookFromISBN = fetchBookFromISBN;

// Fetch books function - inline
function fetchBooks() {
    const isbns = $('#fetchISBNs').val().split('\n').map(isbn => isbn.trim()).filter(isbn => isbn);
    
    if (isbns.length === 0) {
        showToast('LÃ¼tfen en az bir ISBN girin', 'warning');
        return;
    }
    
    $.ajax({
        url: '/api/books/fetch',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ isbns: isbns }),
        success: function(response) {
            displayFetchedBooks(response.books);
            $('#fetchedBooksTable').show();
        },
        error: function() {
            showToast('Kitap bilgileri alÄ±nÄ±rken hata oluÅŸtu', 'error');
        }
    });
}

// Display fetched books - inline
function displayFetchedBooks(books) {
    const tbody = $('#fetchedBooksBody');
    tbody.empty();
    window.fetchedBooks = books; // Global'e kaydet
    
    books.forEach((book, index) => {
        const actionButton = book.error ? 
            '<span class="text-danger">Bilgi bulunamadÄ±</span>' :
            `<button class="btn btn-sm btn-success" onclick="saveFetchedBook(${index})">Kaydet</button>`;
            
        tbody.append(`
            <tr>
                <td><code>${book.isbn}</code></td>
                <td>${book.title}</td>
                <td>${book.authors}</td>
                <td>${actionButton}</td>
            </tr>
        `);
    });
}

// Save fetched book - inline
function saveFetchedBook(index) {
    const book = window.fetchedBooks[index];
    
    $.ajax({
        url: '/api/books/add',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(book),
        success: function() {
            showToast(`"${book.title}" kaydedildi`, 'success');
            window.fetchedBooks.splice(index, 1);
            displayFetchedBooks(window.fetchedBooks);
            if (typeof loadBooks === 'function') {
                loadBooks(currentBookPage);
            }
        },
        error: function(xhr) {
            showToast(xhr.responseJSON?.message || 'Kaydetme hatasÄ±', 'error');
        }
    });
}

// Save all fetched books - inline
function saveAllFetchedBooks() {
    const validBooks = window.fetchedBooks.filter(book => !book.error);
    
    if (validBooks.length === 0) {
        showToast('Kaydedilecek geÃ§erli kitap yok', 'warning');
        return;
    }
    
    if (confirm(`${validBooks.length} kitabÄ± kaydetmek istediÄŸinizden emin misiniz?`)) {
        let saved = 0;
        let errors = 0;
        
        validBooks.forEach((book, index) => {
            $.ajax({
                url: '/api/books/add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(book),
                success: function() {
                    saved++;
                    if (saved + errors === validBooks.length) {
                        showToast(`${saved} kitap kaydedildi`, 'success');
                        $('#fetchBooksModal').modal('hide');
                        if (typeof loadBooks === 'function') {
                            loadBooks(1);
                        }
                    }
                },
                error: function() {
                    errors++;
                    if (saved + errors === validBooks.length) {
                        showToast(`${saved} kitap kaydedildi, ${errors} hata`, 'warning');
                    }
                }
            });
        });
    }
}

// Export books - inline
function exportBooks() {
    const link = document.createElement('a');
    link.href = '/api/export/books';
    link.download = `kitaplar_${new Date().toISOString().split('T')[0]}.xlsx`;
    link.click();
    showToast('Excel dosyasÄ± indiriliyor...', 'success');
}

// Import books - inline
function importBooks() {
    const fileInput = $('#importFile')[0];
    
    if (!fileInput.files.length) {
        showToast('LÃ¼tfen bir dosya seÃ§in', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    $.ajax({
        url: '/api/import/books',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            showToast(response.message, 'success');
            $('#importModal').modal('hide');
            if (typeof loadBooks === 'function') {
                loadBooks(1);
            }
        },
        error: function(xhr) {
            showToast(xhr.responseJSON?.message || 'Ä°Ã§e aktarma hatasÄ±', 'error');
        }
    });
}

$(function() {
    // Yeni Kitap Ekleme Form Handler - KAYDET BUTONU Ä°Ã‡Ä°N
    $('#addBookForm').on('submit', function(e) {
        e.preventDefault();
        
        // addBook() fonksiyonunu Ã§aÄŸÄ±r (books-and-transactions.js'de tanÄ±mlÄ±)
        if (typeof addBook === 'function') {
            addBook();
        } else {
            // Fallback: Direkt AJAX
            const isbn = $('#addBookISBN').val().trim();
            if (!isbn) {
                showToast('ISBN numarasÄ± gerekli', 'warning');
                return;
            }
            
            const bookData = {
                isbn: isbn,
                title: $('#addBookTitle').val(),
                authors: $('#addBookAuthors').val(),
                publishers: $('#addBookPublishers').val(),
                publish_date: $('#addBookPublishDate').val(),
                number_of_pages: $('#addBookPages').val(),
                languages: $('#addBookLanguages').val(),
                quantity: $('#addBookQuantity').val() || 1,
                shelf: $('#addBookShelf').val(),
                cupboard: $('#addBookCupboard').val()
            };
            
            // Kategoriler
            const selectedCategories = $('#addBookCategories').val();
            if (selectedCategories && selectedCategories.length > 0) {
                bookData.category = selectedCategories.join(',');
            }
            
            // Submit butonu loading
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.html('<i class="spinner-border spinner-border-sm me-2"></i>Kaydediliyor...').prop('disabled', true);
            
            $.ajax({
                url: '/api/books/add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(bookData),
                success: function(response) {
                    showToast('Kitap baÅŸarÄ±yla eklendi!', 'success');
                    $('#addBookModal').modal('hide');
                    $('#addBookForm')[0].reset();
                    if (typeof loadBooks === 'function') {
                        loadBooks(1);
                    }
                },
                error: function(xhr) {
                    const message = xhr.responseJSON?.message || 'Kitap eklenirken hata oluÅŸtu';
                    showToast(message, 'error');
                },
                complete: function() {
                    submitBtn.html(originalText).prop('disabled', false);
                }
            });
        }
    });
    
    // Kitap DÃ¼zenleme Form Handler
    $('#editBookForm').on('submit', function(e) {
        e.preventDefault();
        
        // updateBook() fonksiyonunu Ã§aÄŸÄ±r (books-and-transactions.js'de tanÄ±mlÄ±)
        if (typeof updateBook === 'function') {
            updateBook();
        }
    });
    
    $('#selectAllBooks').on('change', function() {
        $('.book-checkbox').prop('checked', this.checked);
    });
    $('#bulkQrBtn').on('click', function() {
        const selected = $('.book-checkbox:checked').map(function(){return this.value;}).get();
        if(selected.length === 0) {
            showToast('LÃ¼tfen en az bir kitap seÃ§in', 'warning');
            return;
        }
        // PDF indirmek iÃ§in POST ile veri gÃ¶nder
        const form = $('<form>', {method: 'POST', action: '/api/books/qr-bulk', target: '_blank'});
        $('<input>', {type: 'hidden', name: 'isbns', value: JSON.stringify(selected)}).appendTo(form);
        form.appendTo('body').submit().remove();
    });
    $('#bulkPdfBtn').on('click', function() {
        const selected = $('.book-checkbox:checked').map(function(){return this.value;}).get();
        if(selected.length === 0) {
            showToast('LÃ¼tfen en az bir kitap seÃ§in', 'warning');
            return;
        }
        // PDF indirmek iÃ§in POST ile veri gÃ¶nder
        const form = $('<form>', {method: 'POST', action: '/api/books/pdf-bulk', target: '_blank'});
        $('<input>', {type: 'hidden', name: 'isbns', value: JSON.stringify(selected)}).appendTo(form);
        form.appendTo('body').submit().remove();
    });
    
    // Excel Import Form Handler
    $('#importForm').on('submit', function(e) {
        e.preventDefault();
        
        // Auto-complete modunda mÄ± kontrol et
        if ($(this).hasClass('auto-complete-mode') && window.autoCompletedBooks) {
            // Otomatik tamamlanmÄ±ÅŸ verileri direkt import et
            importAutoCompletedBooks(window.autoCompletedBooks);
            return;
        }
        
        const fileInput = $('#importFile')[0];
        if (!fileInput.files.length) {
            showToast('LÃ¼tfen bir Excel dosyasÄ± seÃ§in', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        // Loading state with progress
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="spinner-border spinner-border-sm me-2"></i>YÃ¼kleniyor...')
               .prop('disabled', true);
        
        // Progress indicator for large files
        const fileSize = fileInput.files[0].size;
        if (fileSize > 100000) {
            const progressHtml = `
                <div id="bookImportProgress" class="mt-3">
                    <div class="progress">
                        <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        ðŸ“š Kitaplar iÅŸleniyor... BÃ¼yÃ¼k dosyalar iÃ§in lÃ¼tfen bekleyin
                    </small>
                </div>
            `;
            $(this).find('.modal-body').append(progressHtml);
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 12;
                if (progress > 95) progress = 95;
                
                $('#bookImportProgress .progress-bar').css('width', progress + '%');
            }, 600);
            
            $(document).one('book-import-complete', function() {
                clearInterval(progressInterval);
                $('#bookImportProgress .progress-bar').css('width', '100%');
            });
        }
        
        $.ajax({
            url: '/api/import/books',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            timeout: 300000, // 5 dakika timeout (bÃ¼yÃ¼k dosyalar iÃ§in)
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    $('#importModal').modal('hide');
                    if (typeof loadBooks === 'function') {
                        loadBooks(1);
                    }
                } else {
                    showToast(response.message, 'error');
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Excel yÃ¼kleme hatasÄ±';
                showToast(message, 'error');
                    },
        complete: function() {
            $(document).trigger('book-import-complete');
            setTimeout(() => {
                submitBtn.html(originalText).prop('disabled', false);
                $('#bookImportProgress').fadeOut(300, function() {
                    $(this).remove();
                });
            }, 1500);
        }
        });
    });

    // Excel file Ã¶nizleme ve otomatik tamamlama Ã¶zellikleri
    $('#importFile').on('change', function() {
        const file = this.files[0];
        if (!file) {
            $('#previewCard').hide();
            $('#isbnAutoCompleteCard').hide();
            return;
        }

        // Excel dosyasÄ±nÄ± oku ve Ã¶nizle
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'binary'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                if (jsonData.length > 0) {
                    showPreviewTable(jsonData);
                    checkForAutoCompleteOption(jsonData);
                }
            } catch (error) {
                console.error('Excel okuma hatasÄ±:', error);
                showToast('Excel dosyasÄ± okunamadÄ±. LÃ¼tfen geÃ§erli bir Excel dosyasÄ± seÃ§in.', 'error');
            }
        };
        reader.readAsBinaryString(file);
    });

    // Otomatik tamamlama butonu click handler
    $('#autoCompleteBtn').on('click', function() {
        autoCompleteFromISBNs();
    });

    // Ã–nizleme tablosunu gÃ¶ster
    function showPreviewTable(data) {
        if (data.length === 0) return;
        
        let html = '<table class="table table-sm table-striped">';
        
        // Header
        if (data[0]) {
            html += '<thead class="table-dark"><tr>';
            data[0].forEach(header => {
                html += `<th>${header || 'BoÅŸ'}</th>`;
            });
            html += '</tr></thead>';
        }
        
        // Ä°lk 10 satÄ±rÄ± gÃ¶ster
        html += '<tbody>';
        for (let i = 1; i < Math.min(11, data.length); i++) {
            if (data[i]) {
                html += '<tr>';
                for (let j = 0; j < (data[0] || []).length; j++) {
                    html += `<td>${data[i][j] || ''}</td>`;
                }
                html += '</tr>';
            }
        }
        if (data.length > 11) {
            html += `<tr><td colspan="${data[0].length}" class="text-center text-muted">... ve ${data.length - 11} satÄ±r daha</td></tr>`;
        }
        html += '</tbody></table>';
        
        $('#previewTable').html(html);
        $('#previewCard').show();
    }

    // Auto-complete seÃ§eneÄŸini kontrol et
    function checkForAutoCompleteOption(data) {
        if (data.length < 2) return;
        
        const headers = data[0].map(h => (h || '').toString().toLowerCase());
        const hasISBN = headers.some(h => h.includes('isbn') || h.includes('kitap_no'));
        
        if (hasISBN) {
            // DiÄŸer gerekli sÃ¼tunlarÄ±n kaÃ§Ä±nÄ±n boÅŸ olduÄŸunu kontrol et
            const requiredHeaders = ['baÅŸlÄ±k', 'title', 'yazar', 'author'];
            const hasCompleteData = requiredHeaders.some(rh => 
                headers.some(h => h.includes(rh))
            );
            
            if (!hasCompleteData) {
                $('#isbnAutoCompleteCard').show();
                $('#autoCompleteStatus').text('Eksik bilgiler tespit edildi. ISBN\'lerden otomatik tamamlama yapabilirsiniz.');
            }
        }
    }

    // ISBN'lerden otomatik tamamlama
    function autoCompleteFromISBNs() {
        const file = $('#importFile')[0].files[0];
        if (!file) {
            showToast('Ã–nce bir Excel dosyasÄ± seÃ§in', 'warning');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'binary'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // ISBN sÃ¼tununu bul
                let isbns = [];
                jsonData.forEach(row => {
                    Object.keys(row).forEach(key => {
                        if (key.toLowerCase().includes('isbn') || key.toLowerCase().includes('kitap_no')) {
                            const isbn = row[key]?.toString().trim();
                            if (isbn && isbn.length >= 10) {
                                isbns.push(isbn);
                            }
                        }
                    });
                });

                if (isbns.length === 0) {
                    showToast('Excel dosyasÄ±nda ISBN bilgisi bulunamadÄ±', 'warning');
                    return;
                }

                // TekrarlarÄ± temizle
                isbns = [...new Set(isbns)];
                
                if (isbns.length > 50) {
                    if (!confirm(`${isbns.length} adet ISBN bulundu. Bu Ã§ok fazla API isteÄŸi yapacak. Devam etmek istiyor musunuz?`)) {
                        return;
                    }
                }

                fetchBooksFromISBNs(isbns);

            } catch (error) {
                console.error('Excel iÅŸleme hatasÄ±:', error);
                showToast('Excel dosyasÄ± iÅŸlenemedi', 'error');
            }
        };
        reader.readAsBinaryString(file);
    }

    // ISBN listesinden kitap bilgilerini Ã§ek
    function fetchBooksFromISBNs(isbns) {
        const btn = $('#autoCompleteBtn');
        const progress = $('#autoCompleteProgress');
        const statusEl = $('#autoCompleteStatus');
        
        btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm"></i> Ä°ÅŸleniyor...');
        progress.show();
        
        let completed = 0;
        const total = isbns.length;
        const results = [];
        
        statusEl.text(`0/${total} ISBN iÅŸlendi`);
        
        // Batch olarak iÅŸle (5'er 5'er)
        const batchSize = 5;
        let currentBatch = 0;
        
        function processBatch() {
            const start = currentBatch * batchSize;
            const end = Math.min(start + batchSize, isbns.length);
            const currentISBNs = isbns.slice(start, end);
            
            if (currentISBNs.length === 0) {
                // TamamlandÄ±
                btn.prop('disabled', false).html('<i class="bi bi-check-circle"></i> TamamlandÄ±');
                progress.hide();
                statusEl.text(`${completed}/${total} ISBN baÅŸarÄ±yla iÅŸlendi`);
                
                // SonuÃ§larÄ± gÃ¶ster
                if (results.length > 0) {
                    displayAutoCompleteResults(results);
                }
                return;
            }
            
            $.ajax({
                url: '/api/books/fetch-bulk',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({isbns: currentISBNs}),
                success: function(response) {
                    if (response.books) {
                        results.push(...response.books);
                    }
                },
                error: function(xhr) {
                    console.error('Batch fetch error:', xhr);
                },
                complete: function() {
                    completed += currentISBNs.length;
                    const progressPercent = (completed / total) * 100;
                    progress.find('.progress-bar').css('width', progressPercent + '%');
                    statusEl.text(`${completed}/${total} ISBN iÅŸlendi`);
                    
                    currentBatch++;
                    // Sonraki batch iÃ§in kÄ±sa bekleme
                    setTimeout(processBatch, 1000);
                }
            });
        }
        
        processBatch();
    }

    // Otomatik tamamlama sonuÃ§larÄ±nÄ± gÃ¶ster
    function displayAutoCompleteResults(results) {
        const successCount = results.filter(r => !r.error).length;
        const errorCount = results.filter(r => r.error).length;
        
        showToast(`${successCount} kitap bilgisi bulundu, ${errorCount} ISBN iÃ§in bilgi bulunamadÄ±`, 'info');
        
        // BaÅŸarÄ±lÄ± sonuÃ§larÄ± Ã¶nizlemede gÃ¶ster
        const successResults = results.filter(r => !r.error);
        if (successResults.length > 0) {
            displayCompletedPreview(successResults);
        }
    }

    // TamamlanmÄ±ÅŸ Ã¶nizlemeyi gÃ¶ster
    function displayCompletedPreview(books) {
        // Global deÄŸiÅŸkende sakla
        window.autoCompletedBooks = books;
        
        let html = '<table class="table table-sm table-striped">';
        html += '<thead class="table-success"><tr>';
        html += '<th>ISBN</th><th>BaÅŸlÄ±k</th><th>Yazar</th><th>YayÄ±nevi</th><th>YÄ±l</th><th>Sayfa</th>';
        html += '</tr></thead><tbody>';
        
        books.forEach(book => {
            html += '<tr>';
            html += `<td>${book.isbn || ''}</td>`;
            html += `<td>${book.title || ''}</td>`;
            html += `<td>${book.authors || ''}</td>`;
            html += `<td>${book.publishers || ''}</td>`;
            html += `<td>${book.publish_date || ''}</td>`;
            html += `<td>${book.number_of_pages || ''}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += `<div class="alert alert-success mt-2">
            <i class="bi bi-check-circle"></i> ${books.length} kitap bilgisi otomatik olarak tamamlandÄ±!
            <br><small>Åžimdi "YÃ¼kle" butonuna basarak bu bilgileri veritabanÄ±na kaydedebilirsiniz.</small>
        </div>`;
        
        $('#previewTable').html(html);
        
        // Excel dosya inputunu kaldÄ±r ve otomatik import moduna geÃ§
        $('#importFile').prop('required', false);
        $('#importForm').addClass('auto-complete-mode');
    }

    // Otomatik tamamlanmÄ±ÅŸ kitaplarÄ± import et
    function importAutoCompletedBooks(books) {
        const submitBtn = $('#importForm button[type="submit"]');
        const originalText = submitBtn.html();
        
        submitBtn.html('<i class="spinner-border spinner-border-sm me-2"></i>Kaydediliyor...')
               .prop('disabled', true);

        $.ajax({
            url: '/api/books/import-bulk',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({books: books}),
            timeout: 300000, // 5 dakika timeout
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    $('#importModal').modal('hide');
                    if (typeof loadBooks === 'function') {
                        loadBooks(1);
                    }
                } else {
                    showToast(response.message, 'error');
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Kitap kaydetme hatasÄ±';
                showToast(message, 'error');
            },
            complete: function() {
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    }

    // === YENÄ°: FETCH MODAL FONKSÄ°YONLARI ===
    
    // Dosya yÃ¼kleme seÃ§eneklerini gÃ¶ster
    function showFetchFileOptions() {
        $('#fetchFileUploadArea').slideToggle();
    }

    // Dosya yÃ¼kleme event handler - Ä°YÄ°LEÅžTÄ°RÄ°LMÄ°Åž
    $('#fetchFileInput').on('change', function() {
        const file = this.files[0];
        if (!file) return;

        console.log('ðŸ“ Dosya seÃ§ildi:', file.name, file.type, file.size);
        showToast('Dosya okunuyor...', 'info');

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let content = e.target.result;
                let isbns = [];

                console.log('ðŸ“– Dosya iÃ§eriÄŸi okundu, boyut:', content.length);

                if (file.name.endsWith('.csv')) {
                    // CSV iÅŸle
                    console.log('ðŸ“Š CSV dosyasÄ± iÅŸleniyor...');
                    const lines = content.split('\n');
                    lines.forEach((line, index) => {
                        const cleanLine = line.trim();
                        if (cleanLine) {
                            // ISBN Ã§Ä±kar (sadece sayÄ±lar ve X)
                            const isbn = cleanLine.replace(/[^0-9X]/g, '');
                            if (isbn.length >= 10) {
                                isbns.push(isbn);
                                console.log(`ðŸ“‹ SatÄ±r ${index + 1}: ${cleanLine} -> ${isbn}`);
                            }
                        }
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // Excel iÅŸle
                    console.log('ðŸ“Š Excel dosyasÄ± iÅŸleniyor...');
                    
                    // XLSX kÃ¼tÃ¼phanesi yÃ¼klÃ¼ mÃ¼ kontrol et
                    if (typeof XLSX === 'undefined') {
                        throw new Error('XLSX kÃ¼tÃ¼phanesi yÃ¼klenmedi');
                    }
                    
                    const workbook = XLSX.read(content, {type: 'binary'});
                    console.log('ðŸ“š Excel workbook okundu:', workbook.SheetNames);
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1}); // Header array olarak
                    
                    console.log('ðŸ“‹ Excel verileri:', jsonData.length, 'satÄ±r');
                    
                    jsonData.forEach((row, rowIndex) => {
                        if (Array.isArray(row)) {
                            row.forEach((cell, cellIndex) => {
                                if (cell) {
                                    const isbn = String(cell).replace(/[^0-9X]/g, '');
                                    if (isbn.length >= 10) {
                                        isbns.push(isbn);
                                        console.log(`ðŸ“‹ SatÄ±r ${rowIndex + 1}, HÃ¼cre ${cellIndex + 1}: ${cell} -> ${isbn}`);
                                    }
                                }
                            });
                        }
                    });
                } else {
                    // TXT iÅŸle
                    console.log('ðŸ“„ TXT dosyasÄ± iÅŸleniyor...');
                    const lines = content.split('\n');
                    lines.forEach((line, index) => {
                        const cleanLine = line.trim();
                        if (cleanLine) {
                            const isbn = cleanLine.replace(/[^0-9X]/g, '');
                            if (isbn.length >= 10) {
                                isbns.push(isbn);
                                console.log(`ðŸ“‹ SatÄ±r ${index + 1}: ${cleanLine} -> ${isbn}`);
                            }
                        }
                    });
                }

                // TekrarlarÄ± temizle
                isbns = [...new Set(isbns)];
                console.log('ðŸ“Š Toplam bulunan ISBN:', isbns.length);
                
                if (isbns.length > 0) {
                    $('#fetchISBNs').val(isbns.join('\n'));
                    $('#fetchFileUploadArea').slideUp();
                    showToast(`âœ… ${isbns.length} ISBN baÅŸarÄ±yla yÃ¼klendi!`, 'success');
                } else {
                    showToast('âŒ Dosyada geÃ§erli ISBN bulunamadÄ±', 'warning');
                }

            } catch (error) {
                console.error('Dosya okuma hatasÄ±:', error);
                showToast('âŒ Dosya okuma hatasÄ±: ' + error.message, 'error');
            }
        };

        reader.onerror = function(error) {
            console.error('FileReader hatasÄ±:', error);
            showToast('âŒ Dosya okuma hatasÄ±', 'error');
        };

        // Dosya tipine gÃ¶re okuma yÃ¶ntemi
        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            console.log('ðŸ“– Excel dosyasÄ± binary olarak okunuyor...');
            reader.readAsBinaryString(file);
        } else {
            console.log('ðŸ“– Metin dosyasÄ± olarak okunuyor...');
            reader.readAsText(file);
        }
    });

    // Fetch ve otomatik kaydet
    function fetchAndSaveAll() {
        const isbns = $('#fetchISBNs').val().split('\n').map(isbn => isbn.trim()).filter(isbn => isbn);
        
        if (isbns.length === 0) {
            showToast('LÃ¼tfen en az bir ISBN girin', 'warning');
            return;
        }

        if (isbns.length > 50) {
            if (!confirm(`${isbns.length} adet ISBN bulundu. Bu Ã§ok fazla API isteÄŸi yapacak. Devam etmek istiyor musunuz?`)) {
                return;
            }
        }

        // UI gÃ¼ncellemeleri
        const btn = $('#fetchAndSaveBtn');
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="spinner-border spinner-border-sm"></i> Ä°ÅŸleniyor...');

        $('#fetchProgress').show();
        $('#fetchStatus').html('<p class="text-primary">ISBN\'ler iÅŸleniyor...</p>');

        let completed = 0;
        const total = isbns.length;
        const results = [];

        // Batch iÅŸleme (5'er 5'er)
        const batchSize = 5;
        let currentBatch = 0;

        function processBatch() {
            const start = currentBatch * batchSize;
            const end = Math.min(start + batchSize, isbns.length);
            const currentISBNs = isbns.slice(start, end);

            if (currentISBNs.length === 0) {
                // Ä°ÅŸlem tamamlandÄ± - otomatik kaydet
                if (results.length > 0) {
                    const successBooks = results.filter(r => !r.error);
                    if (successBooks.length > 0) {
                        saveDirectlyToDatabase(successBooks, btn, originalText);
                    } else {
                        showToast('HiÃ§ kitap bilgisi bulunamadÄ±', 'warning');
                        btn.prop('disabled', false).html(originalText);
                        $('#fetchProgress').hide();
                    }
                } else {
                    showToast('ISBN iÅŸleme hatasÄ±', 'error');
                    btn.prop('disabled', false).html(originalText);
                    $('#fetchProgress').hide();
                }
                return;
            }

            $.ajax({
                url: '/api/books/fetch-bulk',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({isbns: currentISBNs}),
                success: function(response) {
                    if (response.books) {
                        results.push(...response.books);
                    }
                },
                error: function(xhr) {
                    console.error('Batch fetch error:', xhr);
                },
                complete: function() {
                    completed += currentISBNs.length;
                    const progressPercent = (completed / total) * 100;
                    $('#fetchProgress .progress-bar').css('width', progressPercent + '%');
                    $('#fetchStatus').html(`<p class="text-info">${completed}/${total} ISBN iÅŸlendi</p>`);

                    currentBatch++;
                    setTimeout(processBatch, 1000); // 1 saniye bekleme
                }
            });
        }

        processBatch();
    }

    // DoÄŸrudan veritabanÄ±na kaydet
    function saveDirectlyToDatabase(books, btn, originalText) {
        $('#fetchStatus').html('<p class="text-success">VeritabanÄ±na kaydediliyor...</p>');

        $.ajax({
            url: '/api/books/import-bulk',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({books: books}),
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    // Kitap listesini yenile
                    if (typeof loadBooks === 'function') {
                        setTimeout(() => loadBooks(1), 1000);
                    }
                } else {
                    showToast(response.message, 'error');
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Kaydetme hatasÄ±';
                showToast(message, 'error');
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
                $('#fetchProgress').hide();
                $('#fetchStatus').html('<p class="text-muted small">Ä°ÅŸlem tamamlandÄ±</p>');
            }
        });
    }

    // Eksik kapak resimlerini tamamla
    function downloadMissingCovers() {
        if (!confirm('Kapak resmi eksik kitaplar iÃ§in otomatik resim indirme iÅŸlemi baÅŸlatÄ±lsÄ±n mÄ±?\n(En fazla 20 kitap iÅŸlenir)')) {
            return;
        }

        showToast('Kapak resimleri indiriliyor...', 'info');

        $.ajax({
            url: '/api/books/download-missing-covers',
            method: 'POST',
            timeout: 120000, // 2 dakika timeout
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    
                    // Kitap listesini yenile
                    if (typeof loadBooks === 'function') {
                        setTimeout(() => loadBooks(1), 1000);
                    }
                    
                    // DetaylarÄ± gÃ¶ster
                    if (response.processed > 0) {
                        console.log('Cover download stats:', response);
                    }
                } else {
                    showToast(response.message, 'error');
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || 'Kapak resmi indirme hatasÄ±';
                showToast(message, 'error');
            }
        });
    }

    // PDF Ä°ndir
    function exportBooksPDF() {
        showToast('PDF oluÅŸturuluyor...', 'info');
        fetch('/api/books/list-pdf')
            .then(async (response) => {
                if (!response.ok) {
                    let message = 'PDF indirilemedi';
                    try { message = (await response.json()).error || message; } catch (_) { /* ignore */ }
                    throw new Error(message);
                }
                const ct = (response.headers.get('Content-Type') || '').toLowerCase();
                if (!ct.includes('application/pdf')) {
                    let message = 'PDF oluÅŸturulamadÄ±';
                    try { message = (await response.json()).error || message; } catch (_) { /* ignore */ }
                    throw new Error(message);
                }
                const blob = await response.blob();
                const cd = response.headers.get('Content-Disposition') || '';
                const match = cd.match(/filename="?([^";]+)"?/i);
                const filename = match ? match[1] : `kitaplar_listesi_${new Date().toISOString().slice(0,16).replace(/[-:T]/g,'')}.pdf`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                a.remove();
                showToast('PDF dosyasÄ± indirildi!', 'success');
            })
            .catch((err) => {
                console.error('Books PDF Error:', err);
                showToast(err.message || 'PDF oluÅŸturulurken hata oluÅŸtu', 'error');
            });
    }
    // Global eriÅŸim
    window.exportBooksPDF = exportBooksPDF;
    
    // TÃ¼m kitaplarÄ±n bilgilerini tamamla
    window.completeAllBooksInfo = function() {
        // Onay al
        if (!confirm('TÃœM KÄ°TAPLARIN bilgileri ISBN Ã¼zerinden kontrol edilecek ve gÃ¼ncellenecek.\n\n' +
                    'âš ï¸ Bu iÅŸlem:\n' +
                    'â€¢ TÃ¼m kitaplarÄ± 20\'ÅŸerli gruplar halinde iÅŸleyecek\n' +
                    'â€¢ Dolu alanlarÄ± bile API verileriyle karÅŸÄ±laÅŸtÄ±racak\n' +
                    'â€¢ YanlÄ±ÅŸ/eksik bilgileri dÃ¼zeltecek\n' +
                    'â€¢ Eksik kapak resimlerini indirecek\n' +
                    'â€¢ Uzun sÃ¼rebilir\n\n' +
                    'Devam etmek istiyor musunuz?')) {
            return;
        }
        
        // Global deÄŸiÅŸkenler
        let isProcessing = false;
        let isCancelled = false;
        let allISBNs = [];
        let currentIndex = 0;
        let processedTotal = 0;
        let updatedTotal = 0;
        let verifiedTotal = 0;
        let failedTotal = 0;
        
        // Progress modal oluÅŸtur
        const progressModal = $(`
            <div class="modal fade" id="completeInfoModal" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-database-fill-check"></i> TÃ¼m Kitap Bilgileri DoÄŸrulanÄ±yor ve GÃ¼ncelleniyor
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>KapsamlÄ± GÃ¼ncelleme Modu:</strong> TÃ¼m kitap bilgileri API'den kontrol ediliyor.
                                Mevcut bilgiler de doÄŸrulanÄ±p gerekirse gÃ¼ncellenecek.
                            </div>
                            
                            <div class="mb-3">
                                <h6>Ä°ÅŸlem Durumu:</h6>
                                <div class="progress" style="height: 30px;">
                                    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%">0%</div>
                                </div>
                            </div>
                            
                            <div class="row text-center mb-3">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body p-2">
                                            <h4 id="processedCount">0</h4>
                                            <small>Ä°ÅŸlenen</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body p-2">
                                            <h4 id="updatedCount">0</h4>
                                            <small>GÃ¼ncellenen</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body p-2">
                                            <h4 id="verifiedCount">0</h4>
                                            <small>DoÄŸrulanan</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body p-2">
                                            <h4 id="failedCount">0</h4>
                                            <small>BaÅŸarÄ±sÄ±z</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="currentBatch" class="mb-3" style="display: none;">
                                <h6>Åžu an iÅŸlenen kitaplar: <span id="batchInfo"></span></h6>
                                <div class="list-group" id="batchList" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <div id="completionMessage" class="alert alert-success" style="display: none;">
                                <i class="bi bi-check-circle"></i> <span id="completionText"></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" id="cancelBtn">
                                <i class="bi bi-x-circle"></i> Ä°ptal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        // Modal'Ä± body'e ekle ve gÃ¶ster
        $('body').append(progressModal);
        $('#completeInfoModal').modal('show');
        
        // Ã–nce tÃ¼m ISBN'leri al
        showToast('Kitap listesi alÄ±nÄ±yor...', 'info');
        
        $.ajax({
            url: '/api/books/get-all-isbns',
            method: 'GET',
            success: function(response) {
                if (response.success && response.isbns) {
                    allISBNs = response.isbns;
                    const totalBooks = allISBNs.length;
                    
                    if (totalBooks === 0) {
                        showToast('GÃ¼ncellenecek kitap bulunamadÄ±', 'warning');
                        $('#completeInfoModal').modal('hide');
                        return;
                    }
                    
                    showToast(`${totalBooks} kitap bulundu. Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...`, 'info');
                    isProcessing = true;
                    processBatch();
                } else {
                    showToast('Kitap listesi alÄ±namadÄ±', 'error');
                    $('#completeInfoModal').modal('hide');
                }
            },
            error: function(xhr) {
                showToast('Kitap listesi alÄ±nÄ±rken hata oluÅŸtu', 'error');
                $('#completeInfoModal').modal('hide');
            }
        });
        
        // Batch iÅŸleme fonksiyonu
        function processBatch() {
            if (!isProcessing || isCancelled) {
                return;
            }
            
            const batchSize = 20;
            const batch = allISBNs.slice(currentIndex, currentIndex + batchSize);
            
            if (batch.length === 0) {
                // Ä°ÅŸlem tamamlandÄ±
                completeProcess();
                return;
            }
            
            $('#currentBatch').show();
            $('#batchInfo').text(`(${currentIndex + 1}-${Math.min(currentIndex + batchSize, allISBNs.length)} / ${allISBNs.length})`);
            $('#batchList').empty();
            
            // Batch'teki ISBN'leri gÃ¶ster
            batch.forEach(isbn => {
                $('#batchList').append(`
                    <div class="list-group-item list-group-item-light" data-isbn="${isbn}">
                        <small><i class="spinner-border spinner-border-sm"></i> ${isbn} - Ä°ÅŸleniyor...</small>
                    </div>
                `);
            });
            
            // API Ã§aÄŸrÄ±sÄ±
            $.ajax({
                url: '/api/books/verify-and-update-batch',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    isbns: batch,
                    force_update: true  // TÃ¼m alanlarÄ± gÃ¼ncelle
                }),
                timeout: 120000, // 2 dakika timeout
                success: function(response) {
                    if (response.success) {
                        // SayaÃ§larÄ± gÃ¼ncelle
                        processedTotal += response.processed || batch.length;
                        updatedTotal += response.updated || 0;
                        verifiedTotal += response.verified || 0;
                        failedTotal += response.failed || 0;
                        
                        $('#processedCount').text(processedTotal);
                        $('#updatedCount').text(updatedTotal);
                        $('#verifiedCount').text(verifiedTotal);
                        $('#failedCount').text(failedTotal);
                        
                        // Progress bar gÃ¼ncelle
                        const percentage = Math.round((processedTotal / allISBNs.length) * 100);
                        $('.progress-bar').css('width', percentage + '%').text(percentage + '%');
                        
                        // SonuÃ§larÄ± listede gÃ¶ster
                        if (response.results) {
                            response.results.forEach(result => {
                                const item = $(`#batchList [data-isbn="${result.isbn}"]`);
                                if (result.status === 'updated') {
                                    item.removeClass('list-group-item-light').addClass('list-group-item-success');
                                    item.html(`<small>âœ“ ${result.isbn} - GÃ¼ncellendi (${result.updated_fields?.join(', ') || 'bilgiler'})</small>`);
                                } else if (result.status === 'verified') {
                                    item.removeClass('list-group-item-light').addClass('list-group-item-info');
                                    item.html(`<small>âœ“ ${result.isbn} - DoÄŸrulandÄ±</small>`);
                                } else if (result.status === 'failed') {
                                    item.removeClass('list-group-item-light').addClass('list-group-item-danger');
                                    item.html(`<small>âœ— ${result.isbn} - ${result.error || 'Hata'}</small>`);
                                }
                            });
                        }
                        
                        // Sonraki batch'e geÃ§
                        currentIndex += batchSize;
                        
                        // 1.5 saniye bekle ve devam et (API rate limiting iÃ§in)
                        setTimeout(() => {
                            processBatch();
                        }, 1500);
                        
                    } else {
                        showToast(response.message || 'Batch iÅŸleme hatasÄ±', 'error');
                        isCancelled = true;
                    }
                },
                error: function(xhr) {
                    console.error('Batch processing error:', xhr);
                    const message = xhr.responseJSON?.message || 'Ä°ÅŸlem hatasÄ±';
                    showToast(message, 'error');
                    
                    // Hata durumunda yine de devam et
                    failedTotal += batch.length;
                    $('#failedCount').text(failedTotal);
                    
                    currentIndex += batchSize;
                    setTimeout(() => {
                        processBatch();
                    }, 2000);
                }
            });
        }
        
        // Ä°ÅŸlem tamamlandÄ±ÄŸÄ±nda
        function completeProcess() {
            isProcessing = false;
            $('#currentBatch').hide();
            $('#cancelBtn').text('Kapat').removeClass('btn-danger').addClass('btn-primary');
            
            $('#completionMessage').show();
            $('#completionText').html(`
                <strong>Ä°ÅŸlem tamamlandÄ±!</strong><br>
                â€¢ ${processedTotal} kitap iÅŸlendi<br>
                â€¢ ${updatedTotal} kitap gÃ¼ncellendi<br>
                â€¢ ${verifiedTotal} kitap doÄŸrulandÄ±<br>
                â€¢ ${failedTotal} kitap baÅŸarÄ±sÄ±z<br>
                <small class="text-muted">Toplam sÃ¼re: ${Math.round(processedTotal * 1.5 / 60)} dakika</small>
            `);
            
            // BaÅŸarÄ±lÄ± gÃ¼ncelleme varsa listeyi yenile
            if (updatedTotal > 0) {
                showToast(`${updatedTotal} kitap baÅŸarÄ±yla gÃ¼ncellendi!`, 'success');
                if (typeof loadBooks === 'function') {
                    setTimeout(() => loadBooks(1), 1000);
                }
            }
        }
        
        // Ä°ptal butonu
        $('#cancelBtn').on('click', function() {
            if (isProcessing) {
                if (confirm('Ä°ÅŸlem devam ediyor. Ä°ptal etmek istediÄŸinizden emin misiniz?')) {
                    isCancelled = true;
                    isProcessing = false;
                    showToast('Ä°ÅŸlem iptal edildi', 'warning');
                    $('#completeInfoModal').modal('hide');
                }
            } else {
                $('#completeInfoModal').modal('hide');
            }
        });
        
        // Modal kapandÄ±ÄŸÄ±nda temizle
        $('#completeInfoModal').on('hidden.bs.modal', function() {
            setTimeout(() => {
                $(this).remove();
            }, 500);
        });
    };
});
</script>

<!-- XLSX kÃ¼tÃ¼phanesi - Excel okuma iÃ§in -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock %}
